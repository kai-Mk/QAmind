# Practice 5: 状態を持つもののテスト

## 学習目標

- 状態を持つオブジェクトのテスト方法を理解する
- `beforeEach` / `afterEach` を使ってテスト間の独立性を保てるようになる
- 状態の変化を追跡するテストが書けるようになる

## 状態を持つもののテストの難しさ

カウンターやカートのように **内部状態が変化する** オブジェクトは、テストの順番によって結果が変わる可能性があります。

### よくある問題

```ts
// テスト1: カウンターを1増やす → 1になる ✓
// テスト2: カウンターを1増やす → 1になるはず... 2になった ✗
```

テスト1の状態がテスト2に漏れてしまっています。

## vitestの構文: `beforeEach` / `afterEach`

各テストの前後に実行される処理を定義します。

```ts
describe('Counter', () => {
  let counter: Counter

  beforeEach(() => {
    // 各テストの前に新しいインスタンスを作成
    counter = new Counter()
  })

  it('初期値は0', () => {
    expect(counter.value).toBe(0)
  })

  it('incrementで1増える', () => {
    counter.increment()
    expect(counter.value).toBe(1)
  })

  // ↑ 各テストで counter は独立している
})
```

### `afterEach` の使いどころ

テスト後のクリーンアップに使います。ファイルの削除やタイマーのリセットなど。

```ts
afterEach(() => {
  // テスト後のクリーンアップ
  vi.restoreAllMocks()
})
```

## テスト設計のコツ

1. **各テストは独立** - テスト間で状態を共有しない
2. **初期状態をテスト** - 初期値が正しいかを確認する
3. **操作の前後で検証** - 操作前と操作後の状態を比較する

## 演習

`practices/practice5/target.ts` に定義されているクラスに対して、状態変化を検証するテストを書いてみましょう。

`practices/practice5/target.test.ts` を開いて、`beforeEach` を活用しながらテストを完成させてください。

### ポイント

- `beforeEach` でインスタンスを毎回作り直す
- 初期状態、操作後の状態、連続操作の結果をテストする
- テスト間で状態が漏れていないか意識する
